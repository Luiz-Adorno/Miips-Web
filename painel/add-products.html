<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Miips - Cadastrar Produtos</title>
    <link rel="icon" href="images/mp-icon.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-storage.js"></script>

    <!-- Filepond stylesheet -->
    <link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet">
    <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
        rel="stylesheet">


    <link rel="apple-touch-icon" href="apple-icon.png">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">

    <link rel="stylesheet" href="vendors/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="vendors/themify-icons/css/themify-icons.css">

    <script src="assets/js/simple-mask-money.js"></script>


    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">

    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>

    <link rel="stylesheet" href="assets/css/style.css">


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>

</head>

<body>


    <!-- Left Panel -->

    <aside id="left-panel" class="left-panel">
        <nav class="navbar navbar-expand-sm navbar-default">

            <div class="navbar-header">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu"
                    aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="./"><img src="images/logo.png" alt="Logo"></a>
                <a class="navbar-brand hidden" href="./"><img src="images/logo2.png" alt="Logo"></a>
            </div>

            <div id="main-menu" class="main-menu collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="index.html"> <i class="menu-icon fa fa-dashboard"></i>Visão Geral </a>
                    </li>
                    <h3 class="menu-title">Painel de Controle</h3><!-- /.menu-title -->

                    <li class="active">
                        <a href="estabelecimentos.html"> <i class="menu-icon fa fa-map-marker"></i>Estabelecimentos</a>
                    </li>

                    <li>
                        <a href="#"> <i class="menu-icon fa fa-id-badge"></i>Clientes</a>
                    </li>

                    <li>
                        <a href="#"> <i class="menu-icon fa fa-envelope-o"></i>Mensagens</a>
                    </li>

                    <li>
                        <a href="#"> <i class="menu-icon fa fa-heart"></i>Avaliações</a>
                    </li>


                    <h3 class="menu-title">Para a sua empresa</h3><!-- /.menu-title -->

                    <li>
                        <a href="#"> <i class="menu-icon fa fa-eye"></i>Novidades</a>
                    </li>

                    <li>
                        <a href="#"> <i class="menu-icon fa fa-calendar"></i>Eventos</a>
                    </li>


                    <li>
                        <a href="#"> <i class="menu-icon fa fa-flag"></i>Promoções</a>
                    </li>

                    <h3 class="menu-title">Configurações</h3><!-- /.menu-title -->
                    <li class="menu-item-has-children dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false"> <i class="menu-icon fa fa-gears (alias)"></i>Conta</a>
                        <ul class="sub-menu children dropdown-menu">
                            <li><i class="menu-icon fa fa-shield"></i><a href="profile.html">Dados da conta</a></li>
                            <li><i class="menu-icon fa fa-lock"></i><a href="change-password.html">Trocar a senha</a>
                            </li>
                        </ul>

                    <li>
                        <a href="#" id="btn_logout"> <i class="menu-icon fa fa-sign-out"></i>Sair</a>
                    </li>
                </ul>
            </div><!-- /.navbar-collapse -->
        </nav>
    </aside><!-- /#left-panel -->

    <!-- Left Panel -->

    <!-- Right Panel -->

    <div id="right-panel" class="right-panel">

        <!-- Header-->
        <header id="header" class="header">

            <div class="header-menu">

                <div class="col-sm-7">
                    <a id="menuToggle" class="menutoggle pull-left"><i class="fa fa fa-tasks"></i></a>
                    <div class="header-left">
                        <button class="search-trigger"><i class="fa fa-search"></i></button>
                        <div class="form-inline">
                            <form class="search-form">
                                <input class="form-control mr-sm-2" type="text" placeholder="Search ..."
                                    aria-label="Search">
                                <button class="search-close" type="submit"><i class="fa fa-close"></i></button>
                            </form>
                        </div>

                        <div class="dropdown for-notification">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="notification"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fa fa-bell"></i>
                                <span class="count bg-danger">5</span>
                            </button>
                            <div class="dropdown-menu" aria-labelledby="notification">
                                <p class="red">You have 5 Notification</p>
                                <a class="dropdown-item media bg-flat-color-1" href="#">
                                    <i class="fa fa-check"></i>
                                    <p>Server #1 overloaded.</p>
                                </a>
                                <a class="dropdown-item media bg-flat-color-4" href="#">
                                    <i class="fa fa-info"></i>
                                    <p>Server #2 overloaded.</p>
                                </a>
                                <a class="dropdown-item media bg-flat-color-5" href="#">
                                    <i class="fa fa-warning"></i>
                                    <p>Server #3 overloaded.</p>
                                </a>
                            </div>
                        </div>

                        <div class="dropdown for-message">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="message"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="ti-email"></i>
                                <span class="count bg-primary">9</span>
                            </button>
                            <div class="dropdown-menu" aria-labelledby="message">
                                <p class="red">You have 4 Mails</p>
                                <a class="dropdown-item media bg-flat-color-1" href="#">
                                    <span class="photo media-left"><img alt="avatar" src="images/avatar/1.jpg"></span>
                                    <span class="message media-body">
                                        <span class="name float-left">Jonathan Smith</span>
                                        <span class="time float-right">Just now</span>
                                        <p>Hello, this is an example msg</p>
                                    </span>
                                </a>
                                <a class="dropdown-item media bg-flat-color-4" href="#">
                                    <span class="photo media-left"><img alt="avatar" src="images/avatar/2.jpg"></span>
                                    <span class="message media-body">
                                        <span class="name float-left">Jack Sanders</span>
                                        <span class="time float-right">5 minutes ago</span>
                                        <p>Lorem ipsum dolor sit amet, consectetur</p>
                                    </span>
                                </a>
                                <a class="dropdown-item media bg-flat-color-5" href="#">
                                    <span class="photo media-left"><img alt="avatar" src="images/avatar/3.jpg"></span>
                                    <span class="message media-body">
                                        <span class="name float-left">Cheryl Wheeler</span>
                                        <span class="time float-right">10 minutes ago</span>
                                        <p>Hello, this is an example msg</p>
                                    </span>
                                </a>
                                <a class="dropdown-item media bg-flat-color-3" href="#">
                                    <span class="photo media-left"><img alt="avatar" src="images/avatar/4.jpg"></span>
                                    <span class="message media-body">
                                        <span class="name float-left">Rachel Santos</span>
                                        <span class="time float-right">15 minutes ago</span>
                                        <p>Lorem ipsum dolor sit amet, consectetur</p>
                                    </span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-sm-5">
                    <div class="user-area dropdown float-right">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                            aria-expanded="false">
                            <img class="user-avatar rounded-circle" height="35px" src="images/admin.png"
                                alt="User Avatar" id="avatar_small">
                        </a>

                        <div class="user-menu dropdown-menu">
                            <a class="nav-link" href="profile.html"><i class="fa fa-user"></i> Perfil</a>
                        </div>
                    </div>

                </div>
            </div>

        </header><!-- /header -->
        <!-- Header-->
        <div class="container">
            <div class="form">

                <div class="form-content">

                    <form id="register-form-store">

                        <div class="form-group">
                            <label>Data do Cadastro</label>
                            <input type="text" class="form-control" id="date" disabled="disabled">
                        </div>

                        <p style="color: black;">Imagem do Produto</p>
                        <div style="text-align: center;">
                            <p class="titleH">Arraste a imagem para o campo cinza abaixo ou clique em Browse para
                                adcionar
                                imagem do produto que deseja cadastrar</p>
                            <!-- We'll transform this input into a pond -->

                            <input class="form-content" type="file" accept="image/*" required>
                        </div>
                        <div class="form-group">
                            <label>Nome do Produto</label>
                            <input type="text" class="form-control" id="name_prod" required>
                        </div>
                        <div class="form-group">
                            <label>Categoria do produto a ser cadastrado:</label>
                            <select class="selectpicker form-control" id="selectCat" required>
                                <option value="" hidden>Selecione</option>
                                <option value="Vestuário">Vestuário</option>
                                <option value="Calçado">Calçado</option>
                                <option value="Acessórios">Acessórios (ex: Tocas, bonés, relógios, carteiras, bolsas, etc)</option>
                                <option value="Óculos de sol">Óculos de sol</option>
                                <option value="Joalheria">Joias</option>
                                <option value="Semijoia">Semijoia</option>
                                <option value="Bijuteria">Bijuteria</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gênero direcionado ao público:</label>
                            <select class="selectpicker form-control" id="selectpicker" required>
                                <option value="" hidden>Selecione</option>
                                <option value="Unissex">Unissex</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">Preço Venda</label>
                            <span class="textbox">
                                R$
                            </span>
                            <input class="form-control" inputmode="numeric" id="myInput" required><br>
                        </div>
                        <div class="form-group">
                            <label>Código de Barras</label>
                            <input class="form-control integerInput" type="text" maxlength="13" id="myInput3"
                                placeholder="0" required><br>
                        </div>
                        <div class="form-group">
                            <label>Quantidade em estoque</label>
                            <input class="form-control integerInput" type="text" id="myInput2" placeholder="0"
                                required><br>
                        </div>
                        <div class="form-group">
                            <label>Descrição</label>
                            <input type="text" class="form-control" id="descri" maxlength="370" required>
                        </div>
                        <button style="margin-top: 20px;" type="submit" class="btn btn-primary">Anunciar</button>
                    </form>
                </div>
            </div>
            <div id="preloader" style="display: none;">
                <div id="loader"></div>
            </div>
        </div>

    </div> <!-- .content -->

    <!-- Right Panel -->

    <script>
        $(function () {
            $('.integerInput').on('input', function () {
                this.value = this.value
                    .replace(/[^\d]/g, '');// numbers and decimals only

            });
        });
    </script>

    <script>
        $(function () {
            $('input#myInput').blur();
        });

        $("input#myInput").on({
            keydown: function (e) {
                if (e.which === 32)
                    return false;
            }
        });
        let input = SimpleMaskMoney.setMask('#myInput', {
            prefix: '',
            suffix: '',
            fixed: true,
            fractionDigits: 2,
            decimalSeparator: ',',
            thousandsSeparator: '.',
            emptyOrInvalid: () => {
                return this.SimpleMaskMoney.args.fixed
                    ? `0${this.SimpleMaskMoney.args.decimalSeparator}00`
                    : `_${this.SimpleMaskMoney.args.decimalSeparator}__`;
            }
        });

    </script>

    <script>
        var dNow = new Date;
        var localdate = dNow.getDate() + '/' + (dNow.getMonth() + 1) + '/' + dNow.getFullYear();
        console.log(localdate)
        document.getElementById("date").value = localdate;
    </script>


    <script>
        $("input#myInput2").on({
            keydown: function (e) {
                if (e.which === 32)
                    return false;
            }
        });
    </script>

    <script>
        //Force maxlength input on android
        var input3 = document.querySelector('#myInput3');
        input3.onkeyup = function (e) {
            var max = 13; // The maxlength you want
            if (input3.value.length > max) {
                input3.value = input3.value.substring(0, max);
            }

        };
    </script>

    <script type="text/javascript" src="//assets.locaweb.com.br/locastyle/2.0.6/javascripts/locastyle.js"></script>
    <script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script async="" src="//www.google-analytics.com/analytics.js"></script>

    <script src="vendors/jquery/dist/jquery.min.js"></script>
    <script src="vendors/popper.js/dist/umd/popper.min.js"></script>
    <script src="vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="assets/js/main.js"></script>

    <script src="https://use.fontawesome.com/c560c025cf.js"></script>


    <!-- TODO: Add SDKs for Firebase products that you want to use
https://firebase.google.com/docs/web/setup#available-libraries -->


    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyATjNfxQ4Ihkqqm0-RZdYrUYnLnc0NEWTk",
            authDomain: "miips-7b784.firebaseapp.com",
            databaseURL: "https://miips-7b784.firebaseio.com",
            projectId: "miips-7b784",
            storageBucket: "miips-7b784.appspot.com",
            messagingSenderId: "372462933207",
            appId: "1:372462933207:web:bcf47e105269696dcf8c92"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        //make auth and firestore references
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    <!-- Load FilePond library -->
    <script src="https://unpkg.com/filepond/dist/filepond.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-resize/dist/filepond-plugin-image-resize.js"></script>
    <script src="https://unpkg.com/filepond-plugin-image-transform/dist/filepond-plugin-image-transform.js"></script>
    <script
        src="https://unpkg.com/filepond-plugin-image-exif-orientation/dist/filepond-plugin-image-exif-orientation.min.js"></script>


    <script>

        // ...
        var cnpj = sessionStorage.getItem("last-cnpj");
        var doc_id = sessionStorage.getItem("doc.id");
        if (cnpj === null) {
            window.location.href = 'estabelecimentos.html';
        }
        cnpj_new = cnpj.replace("/", "-");
        //console.log(cnpj_new);
        console.log(doc_id);

        const signupFormStore = document.querySelector('#register-form-store');

        //initialize the plugins

        FilePond.registerPlugin(
            FilePondPluginImagePreview,
            FilePondPluginImageResize,
            FilePondPluginImageExifOrientation,
            FilePondPluginImageTransform);

        const inputElement = document.querySelector('input[type="file"]');
        const pond = FilePond.create(inputElement, {
            imageResizeTargetWidth: 256,

            //callback when te image is added
            onaddfile: (err, fileItem) => {
                // console.log(err, fileItem.getMetadata('resize'))
            },

            //callback for displaying the image on the screen
            onpreparefile: (fileItem, output) => {
                //creating a image object
                const img = new Image();
                URL.createObjectURL(output);

                console.log("out só" + output);

                signupFormStore.addEventListener('submit', (e) => {
                    e.preventDefault();

                    var selectedGender = $('#selectpicker').val();
                    var selectCate = $('#selectCat').val();
                    //console.log(selectedGender);

                    let cateP = new Array();
                    //saving company info
                    const nameP = signupFormStore['name_prod'].value;
                    const qnt = signupFormStore['myInput2'].value
                    const price = signupFormStore['myInput'].value
                    const barcode = signupFormStore['myInput3'].value
                    //console.log(price)
                    const date = signupFormStore['date'].value
                    const descrip = signupFormStore['descri'].value
                    //console.log(date)
                    //transform 01 in 1, 001 in 1, etc... 
                    qnt_new = qnt.replace(/^0+/, "");
                    //console.log(qnt_new)

                    if (price == "0,00") {
                        alert("\nDigite o valor do produto")
                        return false;
                    } else if (qnt_new == 0) {
                        alert("\nDigite a quantidade do produto em estoque")
                    }
                    else {

                        firebase.auth().onAuthStateChanged(function (user) {
                            if (user) {
                                const usersRef = db.collection("companies").doc(user.uid).collection("commercialPlace").doc(doc_id).collection("local")
                                    .doc(cnpj_new).collection("Products").doc(barcode);
                                usersRef.get()
                                    .then((docSnapshot) => {
                                        if (docSnapshot.exists) {
                                            usersRef.onSnapshot((doc) => {
                                                //barcode already exist
                                                alert("\nCódigo de barras já cadastrado na loja")
                                                //console.log(doc)
                                            });
                                        } else {
                                            document.getElementById("preloader").style.display = "block";
                                            //barcode valid
                                            //script to get the img selected on input and send to firebase storage and get de url from there and send to firestore
                                            var storageRef = firebase.storage().ref("companies/" + user.uid + "/images/commercialPlace/productPhoto/" + barcode + "/img");
                                            var task = storageRef.put(output);
                                            task.on('state_changed', function progress(snapshot) {
                                                console.log("onprogress")

                                            }, function error(err) {
                                                console.log("err: " + err)
                                                document.getElementById("preloader").style.display = "none";

                                            }, function complete() {
                                                console.log("complete")
                                                storageRef.getDownloadURL().then(function (url) {

                                                    db.collection("companies").doc(user.uid).collection("commercialPlace").doc(doc_id).collection("local").doc(cnpj_new).set(
                                                        { product_count: firebase.firestore.FieldValue.increment(1) }, { merge: true }).then(function () {
                                                            db.collection("companies").doc(user.uid).collection("commercialPlace").doc(doc_id).collection("local").doc(cnpj_new).collection("Products")
                                                                .doc(barcode).set({
                                                                    gender: selectedGender,
                                                                    product_category: selectCate,
                                                                    url_product: url,
                                                                    nome_produto: nameP,
                                                                    state: true,
                                                                    quantidade: qnt_new,
                                                                    valor: price,
                                                                    cod_barras: barcode,
                                                                    data_cadastro: date,
                                                                    descri: descrip
                                                                }).then(function () {
                                                                    db.collection("commercialPlaces").doc(doc_id).set(
                                                                        { product_count: firebase.firestore.FieldValue.increment(1) }, { merge: true }).then(function () {
                                                                            db.collection("commercialPlaces").doc(doc_id).collection("Product").add({
                                                                                gender: selectedGender,
                                                                                product_category: selectCate,
                                                                                cnpj_owner: cnpj,
                                                                                url_product: url,
                                                                                nome_produto: nameP,
                                                                                state: true,
                                                                                quantidade: qnt_new,
                                                                                valor: price,
                                                                                cod_barras: barcode,
                                                                                data_cadastro: date,
                                                                                descri: descrip
                                                                            })
                                                                                .then(function (docRef) {
                                                                                    document.getElementById("preloader").style.display = "none";
                                                                                    //after add the  go to responsible
                                                                                    window.location.href = 'products.html';
                                                                                })
                                                                                .catch(function (error) {
                                                                                    console.error("Error adding document: ", error);
                                                                                });
                                                                        }).catch(function (error) {
                                                                            console.log("Error getting document:", error);
                                                                            document.getElementById("preloader").style.display = "none";
                                                                        });

                                                                }).catch(function (error) {
                                                                    console.log("Error getting document:", error);
                                                                });

                                                        }).catch(function (error) {
                                                            console.log("Error getting document:", error);
                                                            document.getElementById("preloader").style.display = "none";
                                                        });

                                                }).catch(function (error) {
                                                    document.getElementById("preloader").style.display = "none";
                                                    console.log(error)
                                                    // Handle any errors

                                                });
                                            });


                                        }
                                    });


                            } else {
                                // No user is signed in.
                            }
                        });

                    }

                });

            }
        });


    </script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>

    <script src="scripts/auth_add_products.js"></script>

</body>

</html>